<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AS 관리 - 건설 자재 ERP</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <nav class="nav">
        <a href="dashboard.html">대시보드</a>
        <a href="contract.html">견적</a>
        <a href="inventory.html">재고</a>
        <a href="order.html">발주</a>
        <a href="receiving.html">입고</a>
        <a href="shipment.html">출고</a>
        <!-- <a href="purchase.html">구매</a> -->
        <a href="as.html" class="active">AS</a>
        <a href="materials.html">자재정보</a>
        <a href="project.html">현장 통합 현황</a>
    </nav>

    <main class="main">
        <div class="search-box">
            <div class="search-row">
                <select class="filter-select">
                    <option>상태 전체</option>
                    <option>회수</option>
                    <option>부분</option>
                    <option>출고 대기</option>
                    <option>재출고 완료</option>
                </select>
                <div style="display:flex;gap:0.5rem;flex:1;min-width:200px">
                    <input type="text" class="search-input" placeholder="현장/자재 검색..." style="flex:1">
                    <button class="btn btn-primary" onclick="handleSearch()">검색</button>
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()">초기화</button>
            </div>
        </div>

        <div class="summary-box">
            <div style="display:flex;flex-wrap:wrap;gap:1.5rem">
                <span class="summary-item">회수: <strong>11건</strong></span>
                <span class="summary-item">출고 대기: <strong>5건</strong></span>
                <span class="summary-item">재출고 완료: <strong>45건</strong></span>
                <span class="summary-item">평균 처리: <strong>2.3일</strong></span>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>AS 번호</th>
                        <th>현장</th>
                        <th>자재</th>
                        <th>수량</th>
                        <th>접수일</th>
                        <th>경과</th>
                        <th>상태</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody>
                    <tr onclick="showDetail()">
                        <td><strong>AS-2024-001</strong></td>
                        <td>강남 오피스텔</td>
                        <td>IP카메라 2MP</td>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.5rem">
                                <span>5</span>
                                <span style="font-size:0.75rem;color:var(--gray-400)">(잔여 3, 재출고 2)</span>
                            </div>
                        </td>
                        <td>2024-01-20</td>
                        <td>3일</td>
                        <td><span class="status-badge" style="background:var(--info);color:#fff">부분</span></td>
                        <td><button class="btn btn-sm" style="background:var(--warning);color:#fff" onclick="event.stopPropagation();openStatusChangeModal('AS-2024-001')">출고대기 처리</button></td>
                    </tr>
                    <tr onclick="showDetail()">
                        <td><strong>AS-2024-002</strong></td>
                        <td>판교 공장</td>
                        <td>NVR 16채널</td>
                        <td>1</td>
                        <td>2024-01-22</td>
                        <td>1일</td>
                        <td><span class="status-badge status-pending">출고 대기</span></td>
                        <td></td>
                    </tr>
                    <tr onclick="showDetail()">
                        <td><strong>AS-2024-003</strong></td>
                        <td>인천 물류센터</td>
                        <td>온도 센서</td>
                        <td>5</td>
                        <td>2024-01-25</td>
                        <td>0일</td>
                        <td><span class="status-badge status-approved">회수</span></td>
                        <td><button class="btn btn-sm" style="background:var(--warning);color:#fff" onclick="event.stopPropagation();openStatusChangeModal('AS-2024-003')">출고대기 처리</button></td>
                    </tr>
                    <tr onclick="showDetail()">
                        <td><strong>AS-2024-004</strong></td>
                        <td>강남 오피스텔</td>
                        <td>IP카메라 4MP</td>
                        <td>3</td>
                        <td>2024-01-18</td>
                        <td>5일</td>
                        <td><span class="status-badge status-ok">재출고 완료</span></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- 출고대기 처리 모달 -->
    <div class="modal" id="statusChangeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">출고대기 처리 - <span id="statusChangeAsNo"></span></h2>
                <button class="close-btn" onclick="closeModal('statusChangeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box" style="margin-bottom:1rem">
                    <div class="info-row"><span class="info-label">현재 상태</span><span id="currentStatus" class="status-badge status-approved">회수</span></div>
                    <div class="info-row"><span class="info-label">자재</span><span id="statusChangeMaterial">IP카메라 2MP</span></div>
                    <div class="info-row"><span class="info-label">현장</span><span id="statusChangeSite">강남 오피스텔</span></div>
                    <div class="info-row"><span class="info-label">총 수량</span><span id="totalQuantity">5개</span></div>
                </div>
                
                <div style="background:var(--info-light);padding:0.75rem;border-radius:6px;margin-bottom:1rem;border-left:3px solid var(--info)">
                    <div style="font-size:0.8125rem;color:var(--gray-600)">
                        <strong>💡 부분 처리 안내</strong><br>
                        일부 수량만 처리하면 AS 상태가 "부분"으로 표시됩니다.<br>
                        예: 5개 중 2개 처리 → 상태: 부분 (잔여 3, 재출고 2)<br>
                        잔여 수량에 대해 계속 처리할 수 있습니다.
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">처리 수량 *</label>
                    <input type="number" class="form-input" id="processQuantity" placeholder="처리할 수량" min="1" max="5" value="5">
                    <div style="font-size:0.75rem;color:var(--gray-400);margin-top:0.25rem">최대 5개까지 처리 가능</div>
                </div>
                <div class="form-group">
                    <label class="form-label">AS 유형 *</label>
                    <div style="display:flex;gap:1.5rem;margin-top:0.5rem">
                        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer">
                            <input type="radio" name="asType" value="repair" checked>
                            <span>수리 재출고</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer">
                            <input type="radio" name="asType" value="replace">
                            <span>교체 출고</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">처리 내용 *</label>
                    <textarea class="form-textarea" id="recordContent" placeholder="수리/처리 내용을 입력하세요" rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('statusChangeModal')">취소</button>
                <button class="btn btn-primary" onclick="submitRecord()">출고대기 처리</button>
            </div>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content lg">
            <div class="modal-header">
                <h2 class="modal-title">AS 상세 - AS-2024-001</h2>
                <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <div class="info-row"><span class="info-label">AS 번호</span><strong>AS-2024-001</strong></div>
                    <div class="info-row"><span class="info-label">상태</span><span class="status-badge" style="background:var(--info);color:#fff">부분</span></div>
                    <div class="info-row"><span class="info-label">현장</span><span>강남 오피스텔 (SITE-2024-001)</span></div>
                    <div class="info-row"><span class="info-label">자재</span><span>IP카메라 2MP (CAM-001)</span></div>
                    <div class="info-row"><span class="info-label">회수 수량</span><span>5개</span></div>
                    <div class="info-row"><span class="info-label">재출고 완료 수량</span><span>2개</span></div>
                    <div class="info-row"><span class="info-label">잔여 수량</span><strong style="color:var(--warning)">3개</strong></div>
                    <div class="info-row"><span class="info-label">시리얼</span><span>CAM-2024-015, CAM-2024-016, CAM-2024-017, CAM-2024-018, CAM-2024-019</span></div>
                    <div class="info-row"><span class="info-label">접수일</span><span>2024-01-20 10:00</span></div>
                    <div class="info-row"><span class="info-label">경과 시간</span><strong style="color:var(--warning)">3일 2시간</strong></div>
                </div>
                
                <div style="font-weight:600;margin-bottom:0.5rem;font-size:0.875rem">AS 처리 내역</div>
                <div style="background:var(--gray-50);padding:0.75rem;border-radius:6px;margin-bottom:1rem">
                    <div style="display:flex;flex-direction:column;gap:0.5rem;font-size:0.875rem">
                        <div style="display:flex;justify-content:space-between">
                            <span style="color:var(--gray-600)">수리 재출고</span>
                            <strong>2개</strong>
                        </div>
                    </div>
                </div>
                
                <div style="font-weight:600;margin-bottom:0.5rem;font-size:0.875rem">처리 진행 상황</div>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">2024-01-20 10:00</div>
                        <div class="timeline-content">
                            <strong>회수 완료</strong> - 김창고<br>
                            <span style="color:var(--gray-500)">AS 창고 입고 (입고번호: IN-2024-050) | 회수 수량: 5개</span>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">2024-01-21 14:00</div>
                        <div class="timeline-content">
                            <strong>출고대기 처리 (수리 재출고 2개)</strong> - 김수리<br>
                            <span style="color:var(--gray-500)">메인보드 교체 완료. 정상 작동 확인.</span><br>
                            <span style="color:var(--info);font-size:0.8125rem">→ 재출고 완료: 2개 | 잔여: 3개</span>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">2024-01-22 09:30</div>
                        <div class="timeline-content">
                            <strong>부분 재출고 (2개)</strong> - 이출고<br>
                            <span style="color:var(--gray-500)">출고번호: OUT-2024-051 | 수리 재출고 2개 현장 발송</span>
                        </div>
                    </div>
                    <div class="timeline-item pending">
                        <div class="timeline-time">예정</div>
                        <div class="timeline-content" style="color:var(--gray-500)">
                            잔여 3개 처리 대기 중
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('detailModal')">닫기</button>
            </div>
        </div>
    </div>

    <script>
        function showDetail() { document.getElementById('detailModal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function openStatusChangeModal(asNo) {
            document.getElementById('statusChangeAsNo').textContent = asNo;
            document.getElementById('statusChangeModal').classList.add('active');
        }

        function submitRecord() {
            const asType = document.querySelector('input[name="asType"]:checked').value;
            const content = document.getElementById('recordContent').value;
            const quantity = parseInt(document.getElementById('processQuantity').value);
            const totalQuantity = 5; // 실제로는 서버에서 가져온 값
            
            if (!quantity || quantity <= 0) {
                alert('처리 수량을 입력해주세요');
                return;
            }
            
            if (quantity > totalQuantity) {
                alert(`처리 수량은 총 수량(${totalQuantity}개)을 초과할 수 없습니다`);
                return;
            }
            
            if (!content) {
                alert('처리 내용을 입력해주세요');
                return;
            }

            const asTypeText = asType === 'repair' ? '수리 재출고' : '교체 출고';
            
            if (quantity < totalQuantity) {
                alert(`출고대기 처리가 완료되었습니다.\n\nAS 유형: ${asTypeText}\n처리 수량: ${quantity}개\n\nAS 상태가 '부분'으로 변경되었습니다.\n- 잔여: ${totalQuantity - quantity}개 (계속 처리 가능)\n- 재출고: ${quantity}개 (${asTypeText})`);
            } else {
                alert(`출고대기 처리가 완료되었습니다.\n\nAS 유형: ${asTypeText}\n처리 수량: ${quantity}개\n\n전체 수량이 처리되어 상태가 '출고 대기'로 변경되었습니다.`);
            }
            
            closeModal('statusChangeModal');
        }

        document.querySelectorAll('.modal').forEach(m => m.onclick = e => { if (e.target.classList.contains('modal')) e.target.classList.remove('active'); });
    </script>
</body>

</html>